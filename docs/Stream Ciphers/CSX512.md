# CSX512: A parallelized and vectorized ChaCha-512 80-round stream cipher implementation

## Description:
The ChaCha stream cipher generates a key-stream by encrypting successive values of an incrementing 32bit unsigned integer counter array. 
The key-stream is then XOR'd with the input message block to create the cipher-text output. 
In parallel mode, the counter is increased by a number factored from the number and size of input blocks, allowing for a multi-threaded operation. 
The implementation is further parallelized by constructing a larger 'staggered' counter array, and processing large blocks using 128, 256, or 512bit SIMD instructions.
The transformation function used by ChaCha is not limited by a dependency chain; this mode can be both SIMD pipelined and multi-threaded. 
This is achieved by pre-calculating the counters positional offset over multiple 'chunks' of key-stream, which are then generated independently across threads. 
The key stream generated by encrypting the counter array(s), is used as a source of random, and XOR'd with the message input to produce the cipher text.

## Implementation Notes
* The Key size is fixed at 64 bytes (512 bits). 
* The ISymmetricKey nonce value is not used by the Initialize function in this implementation. 
* The ISymmetricKey info value can be used as a cipher tweak to create a unique ciphertext and MAC output. 
* The ciphers Initialize function can use either a SymmetricKey container, or an encrypted SymmetricSecureKey. 
* The internal block size is 64 bytes (512 bits) wide. 
* This cipher is capable of authentication by setting the constructors StreamAuthenticators enumeration to one of the HMAC or KMAC options. 
* In authentication mode, during encryption the MAC code is automatically appended to the output cipher-text after each transform call, during decryption, this MAC code is checked and authentication failure will generate a CryptoAuthenticationFailure exception. 
* If authentication is enabled, the cipher-key and MAC seed are generated using cSHAKE, this will change the cipher-text output. 
* In authenticated mode, the internal keys generated by cSHAKE will be unique with each MAC generator, each authentication option should be considered a seperate and distinct variant of the cipher, for example, CSX512-SHAKE512 or CSX512-HMAC512 
* If authentication is enabled, the cipher-key and MAC key are generated using cSHAKE, the SHAKE generator takes the ciphers formal class name as part of the customization string; changing the authentication mode will create a cipher-text output unique to the ciphers configuration. 
* The Info string is optional, but can be used to create a tweakable cipher; must be 16 bytes in length. 
* Permutation rounds are fixed at 80, but can be changed to 40, by removing the CEX_CHACHA512_STRONG definition from the CexConfig file. 
* The class functions are virtual, and can be accessed from an IStreamCipher instance. 
* The transformation methods can not be called until the Initialize(ISymmetricKey) function has been called. 
* Encryption can both be pipelined (AVX, AVX2, or AVX512), and multi-threaded with any even number of threads, the configuration can be modified using the ParallelProfile() accessor function. 
* If the system supports Parallel processing, and ParallelProfile().IsParallel() is set to true; passing an input block of ParallelProfile().ParallelBlockSize() to the transform will be auto parallelized. 
* The ParallelProfile().ParallelThreadsMax() property is used as the thread count in the parallel loop; this must be an even number no greater than the number of processer cores on the system. 
* ParallelProfile().ParallelBlockSize() is calculated automatically based on processor(s) cache size but can be user defined, but must be evenly divisible by ParallelProfile().ParallelMinimumSize(). 
* The ParallelBlockSize() can be changed through the ParallelProfile() property, the initial size is calculated automatically based on the systems capabilities, and modifying this vale is not recommended 

## Example
```cpp
#include "CSX512.h"

// Encrypt and add a MAC code to an array: 
SymmetricKey kp(Key, Nonce);
CSX512 cipher(StreamAuthenticators::HMACSHA256);
// initialize for encryption
cipher.Initialize(true, kp);
cipher.Transform(Input, InOffset, Output, OutOffset, Length);

// Decrypt and authenticate an array: 
SymmetricKey kp(Key, Nonce);
CSX512 cipher(StreamAuthenticators::HMACSHA256);
// initialize for decryption
cipher.Initialize(false, kp);

// decrypt the ciphertext, if the authentication fails an exception is thrown
try
{
    cipher.Transform(Input, InOffset, Output, OutOffset, Length);
}
catch (CryptoAuthenticationFailure)
{
    // do something...
}
```
       
## Public Member Functions
```cpp
CSX512(const CSX512&)=delete
 ```
Copy constructor: copy is restricted, this function has been deleted

```cpp
CSX512& operator=(const CSX512&)=delete
```
Copy operator: copy is restricted, this function has been deleted

```cpp
CSX512(StreamAuthenticators AuthenticatorType=StreamAuthenticators::KMAC256)
``` 
Initialize the ChaCha-512 cipher

```cpp
~CSX512() override
``` 
Destructor: finalize this class

```cpp
const StreamCiphers Enumeral() override
``` 
Read Only: The stream ciphers enumeration type name

```cpp
const bool IsAuthenticator() override
```
Read Only: The cipher has authentication enabled

```cpp
const bool IsEncryption() override
``` 
Read Only: The cipher has been initialized for encryption

```cpp
const bool IsInitialized() override
``` 
Read Only: The cipher is ready to transform data

```cpp
const bool IsParallel() override
``` 
Read Only: Processor parallelization availability

```cpp
const std::vector<SymmetricKeySize> &LegalKeySizes() override
``` 
Read Only: Array of SymmetricKeySize containers, containing legal cipher input key sizes

```cpp
const std::string Name() override
``` 
Read Only: The stream ciphers formal implementation name

```cpp
const size_t ParallelBlockSize() override
``` 
Read Only: Parallel block size; the byte-size of the input/output data arrays passed to a transform that trigger parallel processing

```cpp
ParallelOptions &ParallelProfile() override
``` 
Read/Write: Parallel and SIMD capability flags and recommended sizes

```cpp
const std::vector<byte> Tag() override
``` 
Read Only: The current standard-vector MAC tag value

```cpp
const void Tag (SecureVector<byte> &Output) override
```
Copy the MAC tag to a secure-vector

```cpp
const size_t TagSize() override
``` 
Read Only: The legal tag length in bytes

```cpp
void Initialize(bool Encryption, ISymmetricKey &Parameters) override
``` 
Initialize the cipher with an ISymmetricKey key container

```cpp
void ParallelMaxDegree(size_t Degree) override
``` 
Set the maximum number of threads allocated when using multi-threaded processing

```cpp
void SetAssociatedData(const std::vector<byte> &Input, const size_t Offset, const size_t Length) override
``` 
Add additional data to the authentication generator

```cpp
void Transform(const std::vector<byte> &Input, size_t InOffset, std::vector<byte> &Output, size_t OutOffset, size_t Length) override
``` 
Encrypt/Decrypt an array of bytes with offset and length parameters

## Links

* [ChaCha](http://cr.yp.to/chacha/chacha-20080128.pdf): Specification 
* [Fips-202](http://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.202.pdf): The SHA-3 Standard 
* [SP800-185](http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-185.pdf): SHA-3 Derived Functions 
* [RFC 2104](http://tools.ietf.org/html/rfc2104): HMAC: Keyed-Hashing for Message Authentication. 
* [Fips 198-1](http://csrc.nist.gov/publications/fips/fips198-1/FIPS-198-1_final.pdf): The Keyed-Hash Message Authentication Code (HMAC). 
* [Fips 180-4](http://csrc.nist.gov/publications/fips/fips180-4/fips-180-4.pdf): Secure Hash Standard (SHS)
