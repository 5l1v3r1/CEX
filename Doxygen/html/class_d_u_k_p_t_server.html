<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CEX++: DUKPTServer Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CEX++
   &#160;<span id="projectnumber">1.0.0.8f</span>
   </div>
   <div id="projectbrief">The CEX Cryptographic Library in C++</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="class_d_u_k_p_t_server-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">DUKPTServer Class Reference<span class="mlabels"><span class="mlabel">final</span></span></div>  </div>
</div><!--header-->
<div class="contents">

<p>A C++ implementation of the ANSI X9.24-3 2017 DUKPT-AES server host  
 <a href="class_d_u_k_p_t_server.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="_d_u_k_p_t_server_8h_source.html">DUKPTServer.h</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:abbccc38658b5214573ad19f7ac2adf65"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_d_u_k_p_t_server.html#abbccc38658b5214573ad19f7ac2adf65">DUKPTServer</a> ()</td></tr>
<tr class="memdesc:abbccc38658b5214573ad19f7ac2adf65"><td class="mdescLeft">&#160;</td><td class="mdescRight">The DUKPTServer constructor  <a href="class_d_u_k_p_t_server.html#abbccc38658b5214573ad19f7ac2adf65">More...</a><br /></td></tr>
<tr class="separator:abbccc38658b5214573ad19f7ac2adf65"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2213e44b5217cbd600f52cc1d32255a2"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_d_u_k_p_t_server.html#a2213e44b5217cbd600f52cc1d32255a2">~DUKPTServer</a> ()</td></tr>
<tr class="memdesc:a2213e44b5217cbd600f52cc1d32255a2"><td class="mdescLeft">&#160;</td><td class="mdescRight">The DUKPTServer destructor  <a href="class_d_u_k_p_t_server.html#a2213e44b5217cbd600f52cc1d32255a2">More...</a><br /></td></tr>
<tr class="separator:a2213e44b5217cbd600f52cc1d32255a2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0242508ae70ed5e27d1b6fce440d1801"><td class="memItemLeft" align="right" valign="top">std::vector&lt; byte &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_d_u_k_p_t_server.html#a0242508ae70ed5e27d1b6fce440d1801">Decrypt</a> (const std::vector&lt; byte &gt; &amp;Bdk, const std::vector&lt; byte &gt; &amp;KeyId, const std::vector&lt; byte &gt; &amp;CipherText)</td></tr>
<tr class="memdesc:a0242508ae70ed5e27d1b6fce440d1801"><td class="mdescLeft">&#160;</td><td class="mdescRight">Decrypt the PIN cipher-text  <a href="class_d_u_k_p_t_server.html#a0242508ae70ed5e27d1b6fce440d1801">More...</a><br /></td></tr>
<tr class="separator:a0242508ae70ed5e27d1b6fce440d1801"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a14a499755c9fb2db55b7142a3992461f"><td class="memItemLeft" align="right" valign="top">std::vector&lt; byte &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_d_u_k_p_t_server.html#a14a499755c9fb2db55b7142a3992461f">DecryptVerify</a> (const std::vector&lt; byte &gt; &amp;Bdk, const std::vector&lt; byte &gt; &amp;KeyId, const std::vector&lt; byte &gt; &amp;CipherText, const std::vector&lt; byte &gt; &amp;AdditionalData)</td></tr>
<tr class="memdesc:a14a499755c9fb2db55b7142a3992461f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Verify a cipher-text's integrity with a keyed MAC, if verified return the decrypted PIN message.  <a href="class_d_u_k_p_t_server.html#a14a499755c9fb2db55b7142a3992461f">More...</a><br /></td></tr>
<tr class="separator:a14a499755c9fb2db55b7142a3992461f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab6e29c26269d08b2f39a2bc02edf81b4"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_d_u_k_p_t_server.html#ab6e29c26269d08b2f39a2bc02edf81b4">DeriveWorkingKey</a> (<a class="el" href="class_dukpt_server_state.html">DukptServerState</a> &amp;State, const std::vector&lt; byte &gt; &amp;Bdk, DukptKeyUsage WorkingKeyUsage, DukptKeyType WorkingKeyType, const std::vector&lt; byte &gt; &amp;InitialKeyId, uint Counter)</td></tr>
<tr class="memdesc:ab6e29c26269d08b2f39a2bc02edf81b4"><td class="mdescLeft">&#160;</td><td class="mdescRight">B.5 Host Derive Working Key; derive a working key for a particular transaction based on a initial key-id and transaction counter  <a href="class_d_u_k_p_t_server.html#ab6e29c26269d08b2f39a2bc02edf81b4">More...</a><br /></td></tr>
<tr class="separator:ab6e29c26269d08b2f39a2bc02edf81b4"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>A C++ implementation of the ANSI X9.24-3 2017 DUKPT-AES server host </p>
<p>Decrypting a PIN message: </p><div class="fragment"><div class="line">std::vector&lt;byte&gt; dec;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">try</span></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// check the message integrity, if it fails it throws without decrypting</span></div>
<div class="line">    dec = srv.DecryptPin(Bdk, Keyid, Ciphertext);</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span> (<a class="code" href="class_crypto_kms_exception.html">CryptoKmsException</a> <span class="keyword">const</span>&amp;)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// invalid ciphertext, do something..</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>Verify and decrypt a PIN message: </p><div class="fragment"><div class="line">std::vector&lt;byte&gt; dec;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">try</span></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// check the message integrity, if it fails throw without decrypting</span></div>
<div class="line">    dec = srv.VerifyDecryptPin(Bdk, Keyid, Ciphertext, Data);</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span> (<a class="code" href="class_crypto_authentication_failure.html">CryptoAuthenticationFailure</a> <span class="keyword">const</span>&amp;)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// authentication failed, do something..</span></div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span> (<a class="code" href="class_crypto_kms_exception.html">CryptoKmsException</a> <span class="keyword">const</span>&amp;)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// invalid ciphertext, do something..</span></div>
<div class="line">}</div>
</div><!-- fragment --> <p><b>Overview:</b> </p>
<p>DUKPT is a key management standard, utilized in conjunction with the Advanced Encryption Standard (AES), to manage symmetric keys that can be used to protect messages and other sensitive information in a financial services environment. It uses a Base Derivation Key (BDK) known only to the transaction processors, to derive intermediate keys (IPEK), that are then used unique device keys for point of sale devices. The devices unique key is used to derive all future working keys, used by the device to encrypt PIN information, sent back to the processing server along with a key identification string and a transaction count number, used to recreate the future key and decrypt the cryptogram.</p>
<p>Guiding Publications: </p><ol>
<li>
ANSI X9.24-3-2017: <a href="https://webstore.ansi.org/standards/ascx9/ansix9242017-1665702">Derived Unique Key Per Transaction: DUKPT-AES</a>. </li>
<li>
ANSI X9.24-3-2017: <a href="https://x9.org/wp-content/uploads/2018/03/X9.24-3-2017-Python-Source-20180129-1.pdf">Official Python implementation</a>. </li>
<li>
ANSI X9.24-3-2017: <a href="https://x9.org/wp-content/uploads/2018/03/X9.24-3-2017-Test-Vectors-20180129-1.pdf">Test vectors</a>. </li>
<li>
NIST <a href="http://csrc.nist.gov/publications/fips/fips197/fips-197.pdf">AES Fips 197</a>. </li>
<li>
HMAC <a href="http://tools.ietf.org/html/rfc2104">RFC 2104</a>. </li>
</ol>
</div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="abbccc38658b5214573ad19f7ac2adf65"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abbccc38658b5214573ad19f7ac2adf65">&#9670;&nbsp;</a></span>DUKPTServer()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">DUKPTServer::DUKPTServer </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The DUKPTServer constructor </p>

</div>
</div>
<a id="a2213e44b5217cbd600f52cc1d32255a2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2213e44b5217cbd600f52cc1d32255a2">&#9670;&nbsp;</a></span>~DUKPTServer()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">DUKPTServer::~DUKPTServer </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The DUKPTServer destructor </p>

</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="a0242508ae70ed5e27d1b6fce440d1801"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0242508ae70ed5e27d1b6fce440d1801">&#9670;&nbsp;</a></span>Decrypt()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::vector&lt; byte &gt; DUKPTServer::Decrypt </td>
          <td>(</td>
          <td class="paramtype">const std::vector&lt; byte &gt; &amp;&#160;</td>
          <td class="paramname"><em>Bdk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::vector&lt; byte &gt; &amp;&#160;</td>
          <td class="paramname"><em>KeyId</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::vector&lt; byte &gt; &amp;&#160;</td>
          <td class="paramname"><em>CipherText</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Decrypt the PIN cipher-text </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Bdk</td><td>The base derivation key</td></tr>
    <tr><td class="paramname">KeyId</td><td>The key identity array and transaction counter</td></tr>
    <tr><td class="paramname">CipherText</td><td>The input cipher-text</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The decrypted PIN plain-text</dd></dl>
<dl class="exception"><dt>Exceptions</dt><dd>
  <table class="exception">
    <tr><td class="paramname">CryptoKmsException</td><td>Thrown if the cipher-text size is invalid</td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a14a499755c9fb2db55b7142a3992461f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a14a499755c9fb2db55b7142a3992461f">&#9670;&nbsp;</a></span>DecryptVerify()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::vector&lt; byte &gt; DUKPTServer::DecryptVerify </td>
          <td>(</td>
          <td class="paramtype">const std::vector&lt; byte &gt; &amp;&#160;</td>
          <td class="paramname"><em>Bdk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::vector&lt; byte &gt; &amp;&#160;</td>
          <td class="paramname"><em>KeyId</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::vector&lt; byte &gt; &amp;&#160;</td>
          <td class="paramname"><em>CipherText</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::vector&lt; byte &gt; &amp;&#160;</td>
          <td class="paramname"><em>AdditionalData</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Verify a cipher-text's integrity with a keyed MAC, if verified return the decrypted PIN message. </p>
<p>This function uses HMAC(SHA2256) to verify the cipher-text integrity before decrypting the message. An optional data can be added to the MAC update, such as the originating clients IP address. If the MAC verifies the cipher-text, the message is decrypted and returned by this function. If the MAC authentication check fails, a CryptoAuthenticationFailure exception is thrown.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Bdk</td><td>The base derivation key</td></tr>
    <tr><td class="paramname">KeyId</td><td>The key identity array and transaction counter</td></tr>
    <tr><td class="paramname">CipherText</td><td>The cipher-text with the appended MAC code</td></tr>
    <tr><td class="paramname">AdditionalData</td><td>The optional additional data used in authentication</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>On success returns decrypted PIN message, on failure throws an exception</dd></dl>
<dl class="exception"><dt>Exceptions</dt><dd>
  <table class="exception">
    <tr><td class="paramname">CryptoAuthenticationFailure</td><td>Thrown before decryption if the the ciphertext fails authentication</td></tr>
    <tr><td class="paramname">CryptoKmsException</td><td>Thrown if the cipher-text size is invalid</td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="ab6e29c26269d08b2f39a2bc02edf81b4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab6e29c26269d08b2f39a2bc02edf81b4">&#9670;&nbsp;</a></span>DeriveWorkingKey()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void DUKPTServer::DeriveWorkingKey </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_dukpt_server_state.html">DukptServerState</a> &amp;&#160;</td>
          <td class="paramname"><em>State</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::vector&lt; byte &gt; &amp;&#160;</td>
          <td class="paramname"><em>Bdk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">DukptKeyUsage&#160;</td>
          <td class="paramname"><em>WorkingKeyUsage</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">DukptKeyType&#160;</td>
          <td class="paramname"><em>WorkingKeyType</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::vector&lt; byte &gt; &amp;&#160;</td>
          <td class="paramname"><em>InitialKeyId</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint&#160;</td>
          <td class="paramname"><em>Counter</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>B.5 Host Derive Working Key; derive a working key for a particular transaction based on a initial key-id and transaction counter </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">State</td><td>The server state; contains the working and derivation keys and derivation data</td></tr>
    <tr><td class="paramname">Bdk</td><td>The base derivation key</td></tr>
    <tr><td class="paramname">WorkingKeyUsage</td><td>The key usage type</td></tr>
    <tr><td class="paramname">WorkingKeyType</td><td>The cipher key type</td></tr>
    <tr><td class="paramname">InitialKeyId</td><td>The initial key id</td></tr>
    <tr><td class="paramname">Counter</td><td>The transaction counter</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The working key structure</dd></dl>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>C:/Users/stepp/Documents/Develop/Github/CEX++/CEX/<a class="el" href="_d_u_k_p_t_server_8h_source.html">DUKPTServer.h</a></li>
<li>C:/Users/stepp/Documents/Develop/Github/CEX++/CEX/DUKPTServer.cpp</li>
</ul>
</div><!-- contents -->
<div class="ttc" id="aclass_crypto_kms_exception_html"><div class="ttname"><a href="class_crypto_kms_exception.html">CryptoKmsException</a></div><div class="ttdoc">Key management system exception</div><div class="ttdef"><b>Definition:</b> CryptoKmsException.h:17</div></div>
<div class="ttc" id="aclass_crypto_authentication_failure_html"><div class="ttname"><a href="class_crypto_authentication_failure.html">CryptoAuthenticationFailure</a></div><div class="ttdoc">Asymmetric cipher/signature, and AEAD mode authentication failure exception container</div><div class="ttdef"><b>Definition:</b> CryptoAuthenticationFailure.h:17</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.18
</small></address>
</body>
</html>
